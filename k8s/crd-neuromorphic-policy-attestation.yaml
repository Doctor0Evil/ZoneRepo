apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: neuromorphicpolicyattestations.zonerepo.io
spec:
  group: zonerepo.io
  scope: Namespaced
  names:
    plural: neuromorphicpolicyattestations
    singular: neuromorphicpolicyattestation
    kind: NeuromorphicPolicyAttestation
    shortNames:
      - npa
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: >
            DID-anchored consent + safety envelope for neuromorphic node classes,
            mirroring ZoneRepoSafetyCertificate and ZoneRepoConsentEnvelope.
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - clusterId
                - namespace
                - nodeClass
                - ethicalCeiling
                - consentEnvelope
                - safetyCertificate
              properties:
                clusterId:
                  type: string
                  description: Logical ID of the neuromorphic cluster (e.g. "phoenix-neuro-1").
                namespace:
                  type: string
                  description: Kubernetes namespace this attestation applies to.
                helmRelease:
                  type: string
                  description: Optional Helm release name tied to this attestation.
                nodeClass:
                  type: string
                  description: >
                    Neuromorphic node class ("loihi-sim", "fpga-bci-adjacent", etc.).
                telemetryContractId:
                  type: string
                  description: Identifier of the telemetry contract this node may touch.
                bciCoupling:
                  type: number
                  format: double
                  minimum: 0.0
                  maximum: 1.0
                  description: >
                    Normalized BCI coupling factor, mapped to RoH/BCI risk; must
                    remain <= 0.3 under current Phoenix ceiling.
                ecoBudget:
                  type: object
                  description: >
                    Ecology-weighted budget for this node class in Phoenix;
                    derived from ZoneRepo eco metrics.
                  properties:
                    maxEcoFearNode:
                      type: number
                      format: double
                    maxEnergyKwhPerDay:
                      type: number
                      format: double
                    regionProfileId:
                      type: string
                ethicalCeiling:
                  type: object
                  description: NeuromorphicEthicalCeiling profile for Phoenix.
                  required:
                    - maxFearIndexNode
                    - maxEcoDamageNode
                    - forbidIrreversibleBio
                  properties:
                    maxFearIndexNode:
                      type: number
                      format: double
                    maxEcoDamageNode:
                      type: number
                      format: double
                    forbidIrreversibleBio:
                      type: boolean
                consentEnvelope:
                  type: object
                  description: >
                    DID-anchored MultiSigConsentEnvelope / ZoneRepoConsentEnvelope
                    extended with neuromorphic fields.
                  required:
                    - transcriptRoot
                    - workspaceHash
                    - fearIndexMax
                    - ecoFearMax
                    - issuerDid
                    - envelopeHash
                  properties:
                    transcriptRoot:
                      type: string
                    workspaceHash:
                      type: string
                    fearIndexMax:
                      type: number
                      format: double
                    ecoFearMax:
                      type: number
                      format: double
                    fairnessScore:
                      type: number
                      format: double
                    issuerDid:
                      type: string
                    additionalSigners:
                      type: array
                      items:
                        type: string
                    envelopeHash:
                      type: string
                    anchors:
                      type: array
                      description: ALN/Googolswarm-style ledger anchors.
                      items:
                        type: object
                        properties:
                          chain:
                            type: string
                          network:
                            type: string
                          txHash:
                            type: string
                          sourceId:
                            type: string
                safetyCertificate:
                  type: object
                  description: >
                    ZoneRepoSafetyCertificate / SovereignCargoCertificate-style VC
                    describing calibrated safe envelope for this node class.
                  required:
                    - certificateId
                    - ethicalCeiling
                    - anchors
                  properties:
                    certificateId:
                      type: string
                    ethicalCeiling:
                      type: object
                      properties:
                        tauP:
                          type: number
                          format: double
                        tauF:
                          type: number
                          format: double
                        tauE:
                          type: number
                          format: double
                    anchors:
                      type: array
                      items:
                        type: object
                        properties:
                          chain:
                            type: string
                          network:
                            type: string
                          txHash:
                            type: string
            status:
              type: object
              properties:
                validated:
                  type: boolean
                lastCheckedAt:
                  type: string
                lastDecision:
                  type: string
                  description: >
                    Last admission decision derived from this attestation
                    ("allowed", "denied-fear", "denied-eco", "denied-bio").
